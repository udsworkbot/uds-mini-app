<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>–î–æ–±–∞–≤–∏—Ç—å —Ä–∞–±–æ—Ç—É</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        .step { display: none; padding: 15px; }
        .active { display: block; }
        select, input { width: 100%; padding: 8px; margin: 10px 0; }
        button { background: #007bff; color: white; border: none; padding: 10px; }
    </style>
</head>
<body>
    <!-- –®–∞–≥ 1: –í—ã–±–æ—Ä —É—á–∞—Å—Ç–∫–∞ -->
    <div id="step1" class="step active">
        <h3>üèó –í—ã–±–µ—Ä–∏—Ç–µ —É—á–∞—Å—Ç–æ–∫:</h3>
        <select id="section"></select>
        <button onclick="showStep(2)">–î–∞–ª–µ–µ</button>
    </div>

    <!-- –®–∞–≥ 2: –í—ã–±–æ—Ä –æ–±—ä–µ–∫—Ç–∞ -->
    <div id="step2" class="step">
        <h3>üìã –í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç:</h3>
        <select id="object"></select>
        <button onclick="showStep(1)">–ù–∞–∑–∞–¥</button>
        <button onclick="showStep(3)">–î–∞–ª–µ–µ</button>
    </div>

    <!-- –®–∞–≥ 3: –í—ã–±–æ—Ä –≤–∏–¥–∞ —Ä–∞–±–æ—Ç -->
    <div id="step3" class="step">
        <h3>üîß –í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥ —Ä–∞–±–æ—Ç:</h3>
        <select id="workType"></select>
        <button onclick="showStep(2)">–ù–∞–∑–∞–¥</button>
        <button onclick="showStep(4)">–î–∞–ª–µ–µ</button>
    </div>

    <!-- –®–∞–≥ 4: –í–≤–æ–¥ –æ–±—ä–µ–º–∞ -->
    <div id="step4" class="step">
        <h3>üìä –í–≤–µ–¥–∏—Ç–µ –æ–±—ä–µ–º:</h3>
        <input type="number" id="volume" step="0.01">
        <button onclick="showStep(3)">–ù–∞–∑–∞–¥</button>
        <button onclick="submitWork()">–ì–æ—Ç–æ–≤–æ</button>
    </div>

    <script>
        let workData = {};
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –ó–∞–≥—Ä—É–∑–∫–∞ —É—á–∞—Å—Ç–∫–æ–≤
        async function loadSections() {
            const response = await fetch('/api/sections');
            const sections = await response.json();
            const select = document.getElementById('section');
            sections.forEach(s => {
                const option = document.createElement('option');
                option.value = s;
                option.text = s;
                select.appendChild(option);
            });
        }

        // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤/–≤–∏–¥–æ–≤ —Ä–∞–±–æ—Ç
        async function loadData(step, section) {
            const endpoint = step === 2 ? `/api/objects?section=${section}` 
                          : `/api/work-types?section=${section}&object=${workData.object}`;
            
            const response = await fetch(endpoint);
            return await response.json();
        }

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è
        async function showStep(step) {
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
            if (step === 2) workData.section = document.getElementById('section').value;
            if (step === 3) workData.object = document.getElementById('object').value;
            
            // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
            if (step === 2) {
                const objects = await loadData(2, workData.section);
                updateSelect('object', objects);
            }
            if (step === 3) {
                const workTypes = await loadData(3, workData.section);
                updateSelect('workType', workTypes);
            }

            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —à–∞–≥–æ–≤
            document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
            document.getElementById(`step${step}`).classList.add('active');
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        function submitWork() {
            workData.volume = parseFloat(document.getElementById('volume').value);
            Telegram.WebApp.sendData(JSON.stringify(workData));
            Telegram.WebApp.close();
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        loadSections();
    </script>
</body>
</html>
